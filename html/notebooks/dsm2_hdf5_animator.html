
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Step 1 &#8212; pydsm 0.2.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Sample book to show how to work with DSM2 Hydro h5" href="sample_hydroh5.html" />
    <link rel="prev" title="DSM2 as a graph network" href="dsm2_input_network.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5.5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<p>This script is to read DSM2 hdf5 output directly and load it into pandas</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">pydsm</span>
<span class="kn">from</span> <span class="nn">pydsm.io</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="section" id="Step-1">
<h1>Step 1<a class="headerlink" href="#Step-1" title="Permalink to this headline">Â¶</a></h1>
<p>Reading in the hdf5 file and table output/channel avg concentration into a pandas frame. This is a multi-dimensional table so hierarchical indices are needed to accomodate it. The attributes for the table contain the start time and time interval and those are used for indexing the first dimension as a datetime</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">read_table_as_array</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    reads table from h5 file_path from the table_path and returns array of dtype</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">table_path</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_dsm2_table</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">table_path</span><span class="p">,</span> <span class="n">column_values</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span> <span class="n">start_time_key</span><span class="o">=</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="n">interval_key</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    file_path: Name of h5 file (full path or relative path)</span>
<span class="sd">    table_path: Path within the h5 file to the values table e.g. /output/channel_concentrations</span>
<span class="sd">    column_values: Values used for the 2nd and 3rd dimension of table.</span>
<span class="sd">        For DSM2 the 2nd dimension is the variable dimension (flow, stage, constituent)</span>
<span class="sd">                 the 3rd dimension is the location dimension (channel, reservoir)</span>
<span class="sd">                 Time is always assumed to be the first dimension in the table</span>
<span class="sd">    column_names: Names for the 2nd and 3rd dimensions</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">v</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">table_path</span><span class="p">]</span>
        <span class="n">a</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">start_time</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">start_time_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">interval</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">interval_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">c1</span><span class="o">=</span><span class="n">column_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c2</span><span class="o">=</span><span class="n">column_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x1</span><span class="o">=</span><span class="n">c1</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">c2</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">x2</span><span class="o">=</span><span class="n">c2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">vi</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">],</span><span class="n">names</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">column_names</span><span class="p">))</span>
    <span class="n">vti</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">index</span><span class="o">=</span><span class="n">vti</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">vi</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">generate_godin_fir</span><span class="p">(</span><span class="n">timeinterval</span><span class="o">=</span><span class="s1">&#39;1hour&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    generate godin filter impulse response for given timeinterval</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mins</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">timeinterval</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mi">60</span> <span class="c1"># FIXME: needs mins_in_interval function</span>
    <span class="n">wts24</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="n">mins</span><span class="p">))</span>
    <span class="n">wts24</span><span class="p">[:]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">wts24</span><span class="o">.</span><span class="n">size</span>
    <span class="n">tidal_period</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mf">24.75</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="n">mins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tidal_period</span><span class="o">%</span><span class="k">2</span>==0: tidal_period=tidal_period+1
    <span class="n">wts25</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tidal_period</span><span class="p">)</span>
    <span class="n">wts25</span><span class="p">[:]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">wts25</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">wts25</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">wts24</span><span class="p">,</span><span class="n">wts24</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">godin_filter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">timeinterval</span><span class="o">=</span><span class="s1">&#39;15min&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    return godin filtered values for data frame values</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">godin_ir</span><span class="o">=</span><span class="n">generate_godin_fir</span><span class="p">(</span><span class="n">timeinterval</span><span class="p">)</span>
    <span class="n">dfg</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">godin_ir</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">))</span>
    <span class="n">dfg</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">return</span> <span class="n">dfg</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../../tests/historical_v82_ec.h5&#39;</span>
<span class="n">na1</span><span class="o">=</span><span class="n">read_table_as_array</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;output/constituent_names&#39;</span><span class="p">)</span>
<span class="n">na2</span><span class="o">=</span><span class="n">read_table_as_array</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;output/channel_number&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="c1">#print(na1,na2)</span>
<span class="n">df</span><span class="o">=</span><span class="n">read_dsm2_table</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;output/channel avg concentration&#39;</span><span class="p">,[</span><span class="n">na1</span><span class="p">,</span><span class="n">na2</span><span class="p">],[</span><span class="s1">&#39;constituent&#39;</span><span class="p">,</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
<span class="c1">#display(df)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dsm2-flowpolygons.geojson&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">dsm2_grid</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">dsm2_grid</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;channel_nu&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ipyleaflet</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">branca.colormap</span> <span class="kn">import</span> <span class="n">linear</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Map">
<h1>Map<a class="headerlink" href="#Map" title="Permalink to this headline">Â¶</a></h1>
<p>Warning: Geojson with polygons for channels is needed!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">max_time_steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">constituent_names</span><span class="o">=</span><span class="n">na1</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">extract_constituent_as_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">constituent_name</span><span class="o">=</span><span class="s1">&#39;ec&#39;</span><span class="p">):</span>
    <span class="n">tblx</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">timestep</span><span class="p">][</span><span class="n">constituent_name</span><span class="p">,</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">tblx</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">tbl0</span><span class="o">=</span><span class="n">extract_constituent_as_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;ec&#39;</span><span class="p">)</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span>
<span class="k">def</span> <span class="nf">make_nice_rounded_range</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">,</span><span class="n">steps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">create_dummy_axis</span><span class="p">()</span>
    <span class="n">x</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">ipyleaflet</span><span class="o">.</span><span class="n">Choropleth</span><span class="p">(</span>
    <span class="n">geo_data</span><span class="o">=</span><span class="n">dsm2_grid</span><span class="p">,</span>
    <span class="n">choro_data</span><span class="o">=</span><span class="n">tbl0</span><span class="p">,</span>
    <span class="n">value_min</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">value_max</span><span class="o">=</span><span class="mi">25000</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="n">linear</span><span class="o">.</span><span class="n">Spectral_11</span><span class="p">,</span> <span class="c1">#linear.YlOrRd_04,</span>
    <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fillOpacity&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">update_legend</span><span class="p">():</span>
    <span class="c1"># add legend</span>
    <span class="n">v</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">choro_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">r</span><span class="o">=</span><span class="n">make_nice_rounded_range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">legend</span><span class="o">=</span><span class="n">linear</span><span class="o">.</span><span class="n">RdBu_11</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">colormap</span><span class="o">=</span><span class="n">legend</span>
    <span class="n">out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_slider_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">choro_data</span><span class="o">=</span><span class="n">extract_constituent_as_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="n">constituent_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_dropdown_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">choro_data</span><span class="o">=</span><span class="n">extract_constituent_as_dict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">constituent_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">update_legend</span><span class="p">()</span>

<span class="c1">#</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">ipyleaflet</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="o">-</span><span class="mi">121</span><span class="p">),</span> <span class="n">zoom</span> <span class="o">=</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="n">ipyleaflet</span><span class="o">.</span><span class="n">FullScreenControl</span><span class="p">())</span>
<span class="c1">#add slider control</span>
<span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">max_time_steps</span><span class="p">,</span> <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">handle_slider_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">play</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Play</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
    <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="nb">max</span><span class="o">=</span><span class="n">max_time_steps</span><span class="p">,</span>
    <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Press play&quot;</span><span class="p">,</span>
    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">widgets</span><span class="o">.</span><span class="n">jslink</span><span class="p">((</span><span class="n">play</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">slider</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">))</span>
<span class="n">constituents</span><span class="o">=</span><span class="n">constituent_names</span>
<span class="n">constituent_selector</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="n">constituents</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s1">&#39;ec&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Constituent:&#39;</span><span class="p">,</span>
    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">constituent_selector</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">handle_dropdown_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="n">control_widget</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">play</span><span class="p">,</span> <span class="n">slider</span><span class="p">])</span>
<span class="n">control_widget</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">constituent_selector</span><span class="p">,</span><span class="n">control_widget</span><span class="p">])</span>
<span class="n">widget_control</span> <span class="o">=</span> <span class="n">ipyleaflet</span><span class="o">.</span><span class="n">WidgetControl</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">control_widget</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottomright&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="n">widget_control</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="s1">&#39;1px solid black&#39;</span><span class="p">})</span>
<span class="n">update_legend</span><span class="p">()</span>
<span class="n">widget_control2</span> <span class="o">=</span> <span class="n">ipyleaflet</span><span class="o">.</span><span class="n">WidgetControl</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;topright&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="n">widget_control2</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#%matplotlib notebook</span>
<span class="n">widget_output</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="s1">&#39;1px solid black&#39;</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">handle_click</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">widget_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cell_id</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">widget_output</span><span class="p">:</span>
        <span class="n">p</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">display</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">fig1</span><span class="p">,</span> <span class="n">axes1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">axes1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">constituent_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell_id</span><span class="p">))</span>
        <span class="n">axes1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">constituent_selector</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="c1">#line1=axes1.axvline(x=slider.value,color=&#39;grey&#39;)</span>
        <span class="c1">#slider.observe(handle_line_)</span>
        <span class="n">godin_filter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,(</span><span class="n">constituent_selector</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)],</span><span class="s1">&#39;1hour&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
<span class="n">layer</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">handle_click</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">widget_output</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
147
148
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\psandhu\AppData\Local\Continuum\anaconda3\envs\dev_pydsm\lib\site-packages\traitlets\traitlets.py:567: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison
  silent = bool(old_value == new_value)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c68099d069564a9e959350bb84700673", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bdc13800e9ed49c5b9837d20a2a1a616", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">pydsm</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">pydsm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">pydsm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="notebooks.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dsm2_h5_read_example.html">Reading hydro hdf5 files from DSM2</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_h5_read_example.html#Hydro-data-file-structure">Hydro data file structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_h5_read_example.html#Channel-indices-to-numbers">Channel indices to numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_h5_read_example.html#Extracting-data">Extracting data</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_read_input.html">Reading Hydro echo files into Pandas DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_read_input.html#Programmatic-inspection-of-input">Programmatic inspection of input</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_read_input.html#Combining-input-tables">Combining input tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_input_network.html">DSM2 as a graph network</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_input_network.html#Utilizing-DSM2-input-information-as-graph-network">Utilizing DSM2 input information as graph network</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_input_network.html#or-between-node-and-reservoir">or between node and reservoir</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_input_network.html#Use-holoviews-visualization-library-for-zoom-and-pan-around-functionality">Use holoviews visualization library for zoom and pan around functionality</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsm2_input_network.html#Test-that-not-all-nodes-are-connected-to-node-1">Test that not all nodes are connected to node 1</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Step 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Map">Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="sample_hydroh5.html">Sample book to show how to work with DSM2 Hydro h5</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="notebooks.html">Examples</a><ul>
      <li>Previous: <a href="dsm2_input_network.html" title="previous chapter">DSM2 as a graph network</a></li>
      <li>Next: <a href="sample_hydroh5.html" title="next chapter">Sample book to show how to work with DSM2 Hydro h5</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Nicky Sandhu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/notebooks/dsm2_hdf5_animator.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>